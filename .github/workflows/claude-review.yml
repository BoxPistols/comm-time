name: AI Code Review (Claude)

on:
  # PRコメントでコマンド駆動
  issue_comment:
    types: [created]
  # PR作成時に自動サマリー
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # /review コマンドでコードレビュー
  claude-review:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            このPRのコード変更をレビューしてください。

            ## レビュー観点
            1. バグや潜在的な問題
            2. セキュリティリスク
            3. パフォーマンス改善点
            4. コードの可読性・保守性
            5. ベストプラクティスへの準拠

            ## 出力形式
            - 問題がある場合は具体的なファイル名と行を示してください
            - 改善案があれば具体的なコード例を提示してください
            - 問題がなければ「LGTM」と回答してください
            - 日本語で回答してください
          model: claude-sonnet-4-20250514
          timeout_minutes: 10

  # /summary コマンドでPRサマリー生成
  claude-summary:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/summary')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude PR Summary
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            このPRの変更内容を要約してください。

            ## 出力形式
            ### 概要
            （1-2文で変更の目的を説明）

            ### 主な変更点
            - 箇条書きで主要な変更を列挙

            ### 影響範囲
            - 影響を受けるコンポーネントや機能

            ### レビューポイント
            - レビュアーが特に確認すべき点

            日本語で回答してください。
          model: claude-sonnet-4-20250514
          timeout_minutes: 10

  # /fix コマンドで修正提案
  claude-fix:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/fix')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Fix Suggestions
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            このPRのコード変更を分析し、具体的な修正提案を行ってください。

            ## 出力形式
            各問題について以下の形式で出力:

            ### 問題 1: [問題のタイトル]
            **ファイル**: `path/to/file.ts`
            **問題点**: 問題の説明
            **修正前**:
            ```typescript
            // 現在のコード
            ```
            **修正後**:
            ```typescript
            // 修正したコード
            ```

            日本語で回答してください。
          model: claude-sonnet-4-20250514
          timeout_minutes: 10

  # PR作成時に自動サマリー
  auto-summary:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API Key
        id: check_key
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "::warning::ANTHROPIC_API_KEY is not set. Skipping auto-summary."
          else
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      - name: Claude Auto Summary
        if: steps.check_key.outputs.has_key == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            このPRの変更内容を要約してください。

            ## 出力形式
            ### 概要
            （1-2文で変更の目的を説明）

            ### 主な変更点
            - 箇条書きで主要な変更を列挙

            ### 影響範囲
            - 影響を受けるコンポーネントや機能

            ### レビューポイント
            - レビュアーが特に確認すべき点

            日本語で回答してください。
          model: claude-sonnet-4-20250514
          timeout_minutes: 10
