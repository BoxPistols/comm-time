name: Supabase Keep Alive

on:
  # æ¯é€±æœˆæ›œæ—¥ 9:00 (JST) = æ—¥æ›œæ—¥ 24:00 UTC
  schedule:
    - cron: '0 0 * * 1'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "âš ï¸ SUPABASE_URL ã¾ãŸã¯ SUPABASE_ANON_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHubãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi

          echo "ğŸ”„ Supabaseã«pingã‚’é€ä¿¡ä¸­..."

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: REST APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${SUPABASE_URL}/rest/v1/" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Supabase is alive! (HTTP $HTTP_CODE)"
            echo "ğŸ“… å®Ÿè¡Œæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          else
            echo "âŒ Supabase ping failed (HTTP $HTTP_CODE)"
            echo "Response: $(echo "$RESPONSE" | head -n -1)"
            exit 1
          fi

      - name: Log success
        run: |
          echo "ğŸ‰ Supabase keep-alive completed successfully"
          echo "æ¬¡å›å®Ÿè¡Œ: 1é€±é–“å¾Œ"
