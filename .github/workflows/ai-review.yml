name: AI Code Review (Gemini)

on:
  # PR„Ç≥„É°„É≥„Éà„Åß„Ç≥„Éû„É≥„ÉâÈßÜÂãï
  issue_comment:
    types: [created]
  # PR‰ΩúÊàêÊôÇ„Å´Ëá™Âãï„Çµ„Éû„É™„ÉºÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # /review „Ç≥„Éû„É≥„Éâ„Åß„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº
  review:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              base: pr.data.base.sha,
              head: pr.data.head.sha,
              branch: pr.data.head.ref
            };

      - name: Get diff
        id: diff
        run: |
          git fetch origin ${{ fromJson(steps.pr.outputs.result).branch }}
          DIFF=$(git diff ${{ fromJson(steps.pr.outputs.result).base }}..${{ fromJson(steps.pr.outputs.result).head }} -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.css' '*.json' | head -c 30000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<PAYLOAD
          {
            "contents": [{
              "parts": [{
                "text": "„ÅÇ„Å™„Åü„ÅØÁµåÈ®ìË±äÂØå„Å™„Ç∑„Éã„Ç¢„Ç®„É≥„Ç∏„Éã„Ç¢„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Ç≥„Éº„ÉâÂ∑ÆÂàÜ„Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n## „É¨„Éì„É•„ÉºË¶≥ÁÇπ\n1. „Éê„Ç∞„ÇÑÊΩúÂú®ÁöÑ„Å™ÂïèÈ°å\n2. „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É™„Çπ„ÇØ\n3. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑÁÇπ\n4. „Ç≥„Éº„Éâ„ÅÆÂèØË™≠ÊÄß„Éª‰øùÂÆàÊÄß\n5. „Éô„Çπ„Éà„Éó„É©„ÇØ„ÉÜ„Ç£„Çπ„Å∏„ÅÆÊ∫ñÊã†\n\n## Âá∫ÂäõÂΩ¢Âºè\n- ÂïèÈ°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂÖ∑‰ΩìÁöÑ„Å™„Éï„Ç°„Ç§„É´Âêç„Å®Ë°å„ÇíÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n- ÊîπÂñÑÊ°à„Åå„ÅÇ„Çå„Å∞ÂÖ∑‰ΩìÁöÑ„Å™„Ç≥„Éº„Éâ‰æã„ÇíÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n- ÂïèÈ°å„Åå„Å™„Åë„Çå„Å∞„ÄåLGTM„Äç„Å®ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\n## „Ç≥„Éº„ÉâÂ∑ÆÂàÜ\n\`\`\`diff\n${{ steps.diff.outputs.diff }}\n\`\`\`"
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 4096
            }
          }
          PAYLOAD
          )

          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "„É¨„Éì„É•„Éº„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü"')
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const review = `## ü§ñ AI Code Review (Gemini)\n\n${{ steps.review.outputs.review }}\n\n---\n*Powered by Gemini 1.5 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

  # /summary „Ç≥„Éû„É≥„Éâ„ÅßPR„Çµ„Éû„É™„ÉºÁîüÊàê
  summary:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/summary')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              title: pr.data.title,
              body: pr.data.body || '',
              base: pr.data.base.sha,
              head: pr.data.head.sha,
              branch: pr.data.head.ref,
              commits: commits.data.map(c => c.commit.message).join('\n')
            };

      - name: Get changed files
        id: files
        run: |
          git fetch origin ${{ fromJson(steps.pr.outputs.result).branch }}
          FILES=$(git diff --name-status ${{ fromJson(steps.pr.outputs.result).base }}..${{ fromJson(steps.pr.outputs.result).head }})
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary with Gemini
        id: summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<PAYLOAD
          {
            "contents": [{
              "parts": [{
                "text": "‰ª•‰∏ã„ÅÆPull RequestÊÉÖÂ†±„Åã„Çâ„ÄÅÁ∞°ÊΩî„ÅßÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ„Çµ„Éû„É™„Éº„ÇíÊó•Êú¨Ë™û„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n## Âá∫ÂäõÂΩ¢Âºè\n### Ê¶ÇË¶Å\nÔºà1-2Êñá„ÅßÂ§âÊõ¥„ÅÆÁõÆÁöÑ„ÇíË™¨ÊòéÔºâ\n\n### ‰∏ª„Å™Â§âÊõ¥ÁÇπ\n- ÁÆáÊù°Êõ∏„Åç„Åß‰∏ªË¶Å„Å™Â§âÊõ¥„ÇíÂàóÊåô\n\n### ÂΩ±ÈüøÁØÑÂõ≤\n- ÂΩ±Èüø„ÇíÂèó„Åë„Çã„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÇÑÊ©üËÉΩ\n\n### „É¨„Éì„É•„Éº„Éù„Ç§„É≥„Éà\n- „É¨„Éì„É•„Ç¢„Éº„ÅåÁâπ„Å´Á¢∫Ë™ç„Åô„Åπ„ÅçÁÇπ\n\n---\n\n## PRÊÉÖÂ†±\n„Çø„Ç§„Éà„É´: ${{ fromJson(steps.pr.outputs.result).title }}\n\nË™¨Êòé:\n${{ fromJson(steps.pr.outputs.result).body }}\n\n„Ç≥„Éü„ÉÉ„Éà:\n${{ fromJson(steps.pr.outputs.result).commits }}\n\nÂ§âÊõ¥„Éï„Ç°„Ç§„É´:\n${{ steps.files.outputs.files }}"
              }]
            }],
            "generationConfig": {
              "temperature": 0.3,
              "maxOutputTokens": 2048
            }
          }
          PAYLOAD
          )

          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "„Çµ„Éû„É™„Éº„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü"')
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## üìã PR Summary (Gemini)\n\n${{ steps.summary.outputs.summary }}\n\n---\n*Powered by Gemini 1.5 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

  # PR‰ΩúÊàê„ÉªÊõ¥Êñ∞ÊôÇ„Å´Ëá™Âãï„Çµ„Éû„É™„ÉºÁîüÊàê
  auto-summary:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            return {
              title: context.payload.pull_request.title,
              body: context.payload.pull_request.body || '',
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha,
              branch: context.payload.pull_request.head.ref,
              commits: commits.data.map(c => c.commit.message).join('\n')
            };

      - name: Get changed files
        id: files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          FILES=$(git diff --name-status origin/${{ github.event.pull_request.base.ref }}..HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary with Gemini
        id: summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<PAYLOAD
          {
            "contents": [{
              "parts": [{
                "text": "‰ª•‰∏ã„ÅÆPull RequestÊÉÖÂ†±„Åã„Çâ„ÄÅÁ∞°ÊΩî„ÅßÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ„Çµ„Éû„É™„Éº„ÇíÊó•Êú¨Ë™û„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n## Âá∫ÂäõÂΩ¢Âºè\n### Ê¶ÇË¶Å\nÔºà1-2Êñá„ÅßÂ§âÊõ¥„ÅÆÁõÆÁöÑ„ÇíË™¨ÊòéÔºâ\n\n### ‰∏ª„Å™Â§âÊõ¥ÁÇπ\n- ÁÆáÊù°Êõ∏„Åç„Åß‰∏ªË¶Å„Å™Â§âÊõ¥„ÇíÂàóÊåô\n\n### ÂΩ±ÈüøÁØÑÂõ≤\n- ÂΩ±Èüø„ÇíÂèó„Åë„Çã„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÇÑÊ©üËÉΩ\n\n### „É¨„Éì„É•„Éº„Éù„Ç§„É≥„Éà\n- „É¨„Éì„É•„Ç¢„Éº„ÅåÁâπ„Å´Á¢∫Ë™ç„Åô„Åπ„ÅçÁÇπ\n\n---\n\n## PRÊÉÖÂ†±\n„Çø„Ç§„Éà„É´: ${{ fromJson(steps.pr.outputs.result).title }}\n\nË™¨Êòé:\n${{ fromJson(steps.pr.outputs.result).body }}\n\n„Ç≥„Éü„ÉÉ„Éà:\n${{ fromJson(steps.pr.outputs.result).commits }}\n\nÂ§âÊõ¥„Éï„Ç°„Ç§„É´:\n${{ steps.files.outputs.files }}"
              }]
            }],
            "generationConfig": {
              "temperature": 0.3,
              "maxOutputTokens": 2048
            }
          }
          PAYLOAD
          )

          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "„Çµ„Éû„É™„Éº„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü"')
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## üìã PR Summary (Gemini)\n\n${{ steps.summary.outputs.summary }}\n\n---\n*Powered by Gemini 1.5 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });

  # /fix „Ç≥„Éû„É≥„Éâ„Åß‰øÆÊ≠£ÊèêÊ°à
  fix:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/fix')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.issue.number }} > diff.txt
          DIFF=$(cat diff.txt | head -c 25000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate fix suggestions with Gemini
        id: fix
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<PAYLOAD
          {
            "contents": [{
              "parts": [{
                "text": "‰ª•‰∏ã„ÅÆ„Ç≥„Éº„ÉâÂ∑ÆÂàÜ„ÇíÂàÜÊûê„Åó„ÄÅÂÖ∑‰ΩìÁöÑ„Å™‰øÆÊ≠£ÊèêÊ°à„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n## Âá∫ÂäõÂΩ¢Âºè\nÂêÑÂïèÈ°å„Å´„Å§„ÅÑ„Å¶‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÂá∫Âäõ:\n\n### ÂïèÈ°å 1: [ÂïèÈ°å„ÅÆ„Çø„Ç§„Éà„É´]\n**„Éï„Ç°„Ç§„É´**: \`path/to/file.ts\`\n**ÂïèÈ°åÁÇπ**: ÂïèÈ°å„ÅÆË™¨Êòé\n**‰øÆÊ≠£Ââç**:\n\`\`\`typescript\n// ÁèæÂú®„ÅÆ„Ç≥„Éº„Éâ\n\`\`\`\n**‰øÆÊ≠£Âæå**:\n\`\`\`typescript\n// ‰øÆÊ≠£„Åó„Åü„Ç≥„Éº„Éâ\n\`\`\`\n\n---\n\n## „Ç≥„Éº„ÉâÂ∑ÆÂàÜ\n\`\`\`diff\n${{ steps.diff.outputs.diff }}\n\`\`\`"
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 4096
            }
          }
          PAYLOAD
          )

          FIX=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "‰øÆÊ≠£ÊèêÊ°à„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü"')
          echo "fix<<EOF" >> $GITHUB_OUTPUT
          echo "$FIX" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post fix suggestions
        uses: actions/github-script@v7
        with:
          script: |
            const fix = `## üîß Fix Suggestions (Gemini)\n\n${{ steps.fix.outputs.fix }}\n\n---\n*Powered by Gemini 1.5 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fix
            });
