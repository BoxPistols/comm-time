name: AI Code Review (Gemini)

on:
  # PRã‚³ãƒ¡ãƒ³ãƒˆã§ã‚³ãƒãƒ³ãƒ‰é§†å‹•
  issue_comment:
    types: [created]
  # PRä½œæˆæ™‚ã«è‡ªå‹•ã‚µãƒãƒªãƒ¼
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  GEMINI_MODEL: gemini-2.0-flash

jobs:
  # /review ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
  review:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API Key
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "::error::GEMINI_API_KEY is not set. Please add it to repository secrets."
            exit 1
          fi

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              base: pr.data.base.sha,
              head: pr.data.head.sha,
              branch: pr.data.head.ref
            };

      - name: Get diff
        id: diff
        run: |
          git fetch origin ${{ fromJson(steps.pr.outputs.result).branch }}
          DIFF=$(git diff ${{ fromJson(steps.pr.outputs.result).base }}..${{ fromJson(steps.pr.outputs.result).head }} -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.css' '*.json' | head -c 30000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {
            "contents": [{
              "parts": [{
                "text": "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚\n\n## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹\n1. ãƒã‚°ã‚„æ½œåœ¨çš„ãªå•é¡Œ\n2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯\n3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç‚¹\n4. ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§\n5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¸ã®æº–æ‹ \n\n## å‡ºåŠ›å½¢å¼\n- å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«åã¨è¡Œã‚’ç¤ºã—ã¦ãã ã•ã„\n- æ”¹å–„æ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚’æç¤ºã—ã¦ãã ã•ã„\n- å•é¡ŒãŒãªã‘ã‚Œã°ã€ŒLGTMã€ã¨å›ç­”ã—ã¦ãã ã•ã„\n\n## ã‚³ãƒ¼ãƒ‰å·®åˆ†\n```diff\n${{ steps.diff.outputs.diff }}\n```"
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 4096
            }
          }
          PAYLOAD
          )

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            ERROR=$(echo "$BODY" | jq -r '.error.message // "Unknown error"')
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "âš ï¸ API Error (HTTP $HTTP_CODE): $ERROR" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            REVIEW=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "$REVIEW" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const review = `## ğŸ¤– AI Code Review (Gemini)\n\n${{ steps.review.outputs.review }}\n\n---\n*Powered by Gemini 2.0 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

  # /summary ã‚³ãƒãƒ³ãƒ‰ã§PRã‚µãƒãƒªãƒ¼ç”Ÿæˆ
  summary:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/summary')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API Key
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "::error::GEMINI_API_KEY is not set. Please add it to repository secrets."
            exit 1
          fi

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              title: pr.data.title,
              body: pr.data.body || '',
              base: pr.data.base.sha,
              head: pr.data.head.sha,
              branch: pr.data.head.ref,
              commits: commits.data.map(c => c.commit.message).join('\n')
            };

      - name: Get changed files
        id: files
        run: |
          git fetch origin ${{ fromJson(steps.pr.outputs.result).branch }}
          FILES=$(git diff --name-status ${{ fromJson(steps.pr.outputs.result).base }}..${{ fromJson(steps.pr.outputs.result).head }})
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary with Gemini
        id: summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {
            "contents": [{
              "parts": [{
                "text": "ä»¥ä¸‹ã®Pull Requestæƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚µãƒãƒªãƒ¼ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n## å‡ºåŠ›å½¢å¼\n### æ¦‚è¦\nï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰\n\n### ä¸»ãªå¤‰æ›´ç‚¹\n- ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™\n\n### å½±éŸ¿ç¯„å›²\n- å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½\n\n### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ\n- ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹\n\n---\n\n## PRæƒ…å ±\nã‚¿ã‚¤ãƒˆãƒ«: ${{ fromJson(steps.pr.outputs.result).title }}\n\nèª¬æ˜:\n${{ fromJson(steps.pr.outputs.result).body }}\n\nã‚³ãƒŸãƒƒãƒˆ:\n${{ fromJson(steps.pr.outputs.result).commits }}\n\nå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:\n${{ steps.files.outputs.files }}"
              }]
            }],
            "generationConfig": {
              "temperature": 0.3,
              "maxOutputTokens": 2048
            }
          }
          PAYLOAD
          )

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            ERROR=$(echo "$BODY" | jq -r '.error.message // "Unknown error"')
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "âš ï¸ API Error (HTTP $HTTP_CODE): $ERROR" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            SUMMARY=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // "ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ“‹ PR Summary (Gemini)\n\n${{ steps.summary.outputs.summary }}\n\n---\n*Powered by Gemini 2.0 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

  # PRä½œæˆãƒ»æ›´æ–°æ™‚ã«è‡ªå‹•ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
  auto-summary:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API Key
        id: check_key
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "has_key=false" >> $GITHUB_OUTPUT
          else
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no API key
        if: steps.check_key.outputs.has_key == 'false'
        run: |
          echo "::warning::GEMINI_API_KEY is not set. Skipping auto-summary."

      - name: Get PR details
        if: steps.check_key.outputs.has_key == 'true'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            return {
              title: context.payload.pull_request.title,
              body: context.payload.pull_request.body || '',
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha,
              branch: context.payload.pull_request.head.ref,
              commits: commits.data.map(c => c.commit.message).join('\n')
            };

      - name: Get changed files
        if: steps.check_key.outputs.has_key == 'true'
        id: files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          FILES=$(git diff --name-status origin/${{ github.event.pull_request.base.ref }}..HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary with Gemini
        if: steps.check_key.outputs.has_key == 'true'
        id: summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {
            "contents": [{
              "parts": [{
                "text": "ä»¥ä¸‹ã®Pull Requestæƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚µãƒãƒªãƒ¼ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n## å‡ºåŠ›å½¢å¼\n### æ¦‚è¦\nï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰\n\n### ä¸»ãªå¤‰æ›´ç‚¹\n- ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™\n\n### å½±éŸ¿ç¯„å›²\n- å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½\n\n### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ\n- ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹\n\n---\n\n## PRæƒ…å ±\nã‚¿ã‚¤ãƒˆãƒ«: ${{ fromJson(steps.pr.outputs.result).title }}\n\nèª¬æ˜:\n${{ fromJson(steps.pr.outputs.result).body }}\n\nã‚³ãƒŸãƒƒãƒˆ:\n${{ fromJson(steps.pr.outputs.result).commits }}\n\nå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:\n${{ steps.files.outputs.files }}"
              }]
            }],
            "generationConfig": {
              "temperature": 0.3,
              "maxOutputTokens": 2048
            }
          }
          PAYLOAD
          )

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            ERROR=$(echo "$BODY" | jq -r '.error.message // "Unknown error"')
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "âš ï¸ API Error (HTTP $HTTP_CODE): $ERROR" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            SUMMARY=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // "ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post summary comment
        if: steps.check_key.outputs.has_key == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ“‹ PR Summary (Gemini)\n\n${{ steps.summary.outputs.summary }}\n\n---\n*Powered by Gemini 2.0 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });

  # /fix ã‚³ãƒãƒ³ãƒ‰ã§ä¿®æ­£ææ¡ˆ
  fix:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/fix')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API Key
        run: |
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "::error::GEMINI_API_KEY is not set. Please add it to repository secrets."
            exit 1
          fi

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.issue.number }} > diff.txt
          DIFF=$(cat diff.txt | head -c 25000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate fix suggestions with Gemini
        id: fix
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {
            "contents": [{
              "parts": [{
                "text": "ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’åˆ†æã—ã€å…·ä½“çš„ãªä¿®æ­£ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚\n\n## å‡ºåŠ›å½¢å¼\nå„å•é¡Œã«ã¤ã„ã¦ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›:\n\n### å•é¡Œ 1: [å•é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«]\n**ãƒ•ã‚¡ã‚¤ãƒ«**: `path/to/file.ts`\n**å•é¡Œç‚¹**: å•é¡Œã®èª¬æ˜\n**ä¿®æ­£å‰**:\n```typescript\n// ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰\n```\n**ä¿®æ­£å¾Œ**:\n```typescript\n// ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰\n```\n\n---\n\n## ã‚³ãƒ¼ãƒ‰å·®åˆ†\n```diff\n${{ steps.diff.outputs.diff }}\n```"
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 4096
            }
          }
          PAYLOAD
          )

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            ERROR=$(echo "$BODY" | jq -r '.error.message // "Unknown error"')
            echo "fix<<EOF" >> $GITHUB_OUTPUT
            echo "âš ï¸ API Error (HTTP $HTTP_CODE): $ERROR" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            FIX=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // "ä¿®æ­£ææ¡ˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "fix<<EOF" >> $GITHUB_OUTPUT
            echo "$FIX" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post fix suggestions
        uses: actions/github-script@v7
        with:
          script: |
            const fix = `## ğŸ”§ Fix Suggestions (Gemini)\n\n${{ steps.fix.outputs.fix }}\n\n---\n*Powered by Gemini 2.0 Flash*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fix
            });
