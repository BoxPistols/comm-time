name: AI Code Review

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  models: read

env:
  # Geminiè¨­å®š
  GEMINI_MODEL: gemini-1.5-flash-8b-001
  GEMINI_MODEL_DISPLAY: Gemini 1.5 Flash 8B
  # GitHub Modelsè¨­å®š (CopilotçµŒç”±)
  GITHUB_MODEL: gpt-4o
  GITHUB_MODEL_DISPLAY: GitHub Copilot (GPT-4o)
  # Claudeè¨­å®š
  CLAUDE_MODEL: claude-sonnet-4-20250514
  CLAUDE_MODEL_DISPLAY: Claude Sonnet 4

jobs:
  # ============================================
  # Gemini Commands: /review, /summary, /fix
  # ============================================
  gemini-review:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/review') &&
      !contains(github.event.comment.body, '/copilot_review') &&
      !contains(github.event.comment.body, '/claude_review')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return { base: pr.data.base.sha, head: pr.data.head.sha, branch: pr.data.head.ref };

      - name: Get diff
        id: diff
        run: |
          git fetch origin ${{ fromJson(steps.pr.outputs.result).branch }}
          DIFF=$(git diff ${{ fromJson(steps.pr.outputs.result).base }}..${{ fromJson(steps.pr.outputs.result).head }} -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.css' '*.json' | head -c 30000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "result=âš ï¸ GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_OUTPUT
            exit 0
          fi
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {"contents":[{"parts":[{"text":"ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚\n\n## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹\n1. ãƒã‚°ã‚„æ½œåœ¨çš„ãªå•é¡Œ\n2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯\n3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç‚¹\n4. ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§\n5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¸ã®æº–æ‹ \n\n## å‡ºåŠ›å½¢å¼\n- å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«åã¨è¡Œã‚’ç¤ºã—ã¦ãã ã•ã„\n- æ”¹å–„æ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚’æç¤ºã—ã¦ãã ã•ã„\n- å•é¡ŒãŒãªã‘ã‚Œã°ã€ŒLGTMã€ã¨å›ç­”ã—ã¦ãã ã•ã„\n\n## ã‚³ãƒ¼ãƒ‰å·®åˆ†\n```diff\n${{ steps.diff.outputs.diff }}\n```"}]}],"generationConfig":{"temperature":0.2,"maxOutputTokens":4096}}
          PAYLOAD
          )
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          if [ "$HTTP_CODE" != "200" ]; then
            ERROR=$(echo "$BODY" | jq -r '.error.message // "Unknown error"')
            echo "result=âš ï¸ API Error (HTTP $HTTP_CODE): $ERROR" >> $GITHUB_OUTPUT
          else
            RESULT=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "result<<EOF" >> $GITHUB_OUTPUT
            echo "$RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ¤– AI Code Review\n\n${{ steps.review.outputs.result }}\n\n---\n*Powered by ${{ env.GEMINI_MODEL_DISPLAY }}*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  gemini-summary:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/summary') &&
      !contains(github.event.comment.body, '/copilot_summary') &&
      !contains(github.event.comment.body, '/claude_summary')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              title: pr.data.title,
              body: pr.data.body || '',
              base: pr.data.base.sha,
              head: pr.data.head.sha,
              branch: pr.data.head.ref,
              commits: commits.data.map(c => c.commit.message).join('\n')
            };

      - name: Get changed files
        id: files
        run: |
          git fetch origin ${{ fromJson(steps.pr.outputs.result).branch }}
          FILES=$(git diff --name-status ${{ fromJson(steps.pr.outputs.result).base }}..${{ fromJson(steps.pr.outputs.result).head }})
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary with Gemini
        id: summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "result=âš ï¸ GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_OUTPUT
            exit 0
          fi
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {"contents":[{"parts":[{"text":"ä»¥ä¸‹ã®Pull Requestæƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚µãƒãƒªãƒ¼ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n## å‡ºåŠ›å½¢å¼\n### æ¦‚è¦\nï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰\n\n### ä¸»ãªå¤‰æ›´ç‚¹\n- ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™\n\n### å½±éŸ¿ç¯„å›²\n- å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½\n\n### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ\n- ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹\n\n---\n\n## PRæƒ…å ±\nã‚¿ã‚¤ãƒˆãƒ«: ${{ fromJson(steps.pr.outputs.result).title }}\n\nèª¬æ˜:\n${{ fromJson(steps.pr.outputs.result).body }}\n\nã‚³ãƒŸãƒƒãƒˆ:\n${{ fromJson(steps.pr.outputs.result).commits }}\n\nå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:\n${{ steps.files.outputs.files }}"}]}],"generationConfig":{"temperature":0.3,"maxOutputTokens":2048}}
          PAYLOAD
          )
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          if [ "$HTTP_CODE" != "200" ]; then
            ERROR=$(echo "$BODY" | jq -r '.error.message // "Unknown error"')
            echo "result=âš ï¸ API Error (HTTP $HTTP_CODE): $ERROR" >> $GITHUB_OUTPUT
          else
            RESULT=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // "ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "result<<EOF" >> $GITHUB_OUTPUT
            echo "$RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ“‹ PR Summary\n\n${{ steps.summary.outputs.result }}\n\n---\n*Powered by ${{ env.GEMINI_MODEL_DISPLAY }}*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  gemini-fix:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/fix') &&
      !contains(github.event.comment.body, '/copilot_fix') &&
      !contains(github.event.comment.body, '/claude_fix')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.issue.number }} > diff.txt
          DIFF=$(cat diff.txt | head -c 25000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate fix with Gemini
        id: fix
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "result=âš ï¸ GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_OUTPUT
            exit 0
          fi
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {"contents":[{"parts":[{"text":"ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’åˆ†æã—ã€å…·ä½“çš„ãªä¿®æ­£ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚\n\n## å‡ºåŠ›å½¢å¼\nå„å•é¡Œã«ã¤ã„ã¦ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›:\n\n### å•é¡Œ 1: [å•é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«]\n**ãƒ•ã‚¡ã‚¤ãƒ«**: `path/to/file.ts`\n**å•é¡Œç‚¹**: å•é¡Œã®èª¬æ˜\n**ä¿®æ­£å‰**:\n```typescript\n// ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰\n```\n**ä¿®æ­£å¾Œ**:\n```typescript\n// ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰\n```\n\n---\n\n## ã‚³ãƒ¼ãƒ‰å·®åˆ†\n```diff\n${{ steps.diff.outputs.diff }}\n```"}]}],"generationConfig":{"temperature":0.2,"maxOutputTokens":4096}}
          PAYLOAD
          )
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          if [ "$HTTP_CODE" != "200" ]; then
            ERROR=$(echo "$BODY" | jq -r '.error.message // "Unknown error"')
            echo "result=âš ï¸ API Error (HTTP $HTTP_CODE): $ERROR" >> $GITHUB_OUTPUT
          else
            RESULT=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // "ä¿®æ­£ææ¡ˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"')
            echo "result<<EOF" >> $GITHUB_OUTPUT
            echo "$RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ”§ Fix Suggestions\n\n${{ steps.fix.outputs.result }}\n\n---\n*Powered by ${{ env.GEMINI_MODEL_DISPLAY }}*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  # ============================================
  # GitHub Copilot Commands: /copilot_review, /copilot_summary, /copilot_fix
  # ============================================
  copilot-review:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/copilot_review')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.issue.number }} > diff.txt
          DIFF=$(cat diff.txt | head -c 30000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Review with GitHub Models
        id: review
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const diff = `${{ steps.diff.outputs.diff }}`;
            const prompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
1. ãƒã‚°ã‚„æ½œåœ¨çš„ãªå•é¡Œ
2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç‚¹
4. ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§
5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¸ã®æº–æ‹ 

## å‡ºåŠ›å½¢å¼
- å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«åã¨è¡Œã‚’ç¤ºã—ã¦ãã ã•ã„
- æ”¹å–„æ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚’æç¤ºã—ã¦ãã ã•ã„
- å•é¡ŒãŒãªã‘ã‚Œã°ã€ŒLGTMã€ã¨å›ç­”ã—ã¦ãã ã•ã„

## ã‚³ãƒ¼ãƒ‰å·®åˆ†
\`\`\`diff
${diff}
\`\`\``;

            try {
              const response = await fetch('https://models.github.ai/inference/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: '${{ env.GITHUB_MODEL }}',
                  messages: [{ role: 'user', content: prompt }],
                  max_tokens: 4096
                })
              });

              if (!response.ok) {
                const error = await response.text();
                core.setOutput('result', `âš ï¸ API Error (HTTP ${response.status}): ${error}`);
                return;
              }

              const data = await response.json();
              core.setOutput('result', data.choices[0].message.content);
            } catch (error) {
              core.setOutput('result', `âš ï¸ Error: ${error.message}`);
            }

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ¤– AI Code Review\n\n${{ steps.review.outputs.result }}\n\n---\n*Powered by ${{ env.GITHUB_MODEL_DISPLAY }}*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  copilot-summary:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/copilot_summary')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              title: pr.data.title,
              body: pr.data.body || '',
              commits: commits.data.map(c => c.commit.message).join('\n')
            };

      - name: Get changed files
        id: files
        run: |
          gh pr diff ${{ github.event.issue.number }} --name-only > files.txt
          FILES=$(cat files.txt)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate summary with GitHub Models
        id: summary
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const prInfo = ${{ steps.pr.outputs.result }};
            const files = `${{ steps.files.outputs.files }}`;
            const prompt = `ä»¥ä¸‹ã®Pull Requestæƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚µãƒãƒªãƒ¼ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å‡ºåŠ›å½¢å¼
### æ¦‚è¦
ï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰

### ä¸»ãªå¤‰æ›´ç‚¹
- ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™

### å½±éŸ¿ç¯„å›²
- å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹

---

## PRæƒ…å ±
ã‚¿ã‚¤ãƒˆãƒ«: ${prInfo.title}

èª¬æ˜:
${prInfo.body}

ã‚³ãƒŸãƒƒãƒˆ:
${prInfo.commits}

å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:
${files}`;

            try {
              const response = await fetch('https://models.github.ai/inference/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: '${{ env.GITHUB_MODEL }}',
                  messages: [{ role: 'user', content: prompt }],
                  max_tokens: 2048
                })
              });

              if (!response.ok) {
                const error = await response.text();
                core.setOutput('result', `âš ï¸ API Error (HTTP ${response.status}): ${error}`);
                return;
              }

              const data = await response.json();
              core.setOutput('result', data.choices[0].message.content);
            } catch (error) {
              core.setOutput('result', `âš ï¸ Error: ${error.message}`);
            }

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ“‹ PR Summary\n\n${{ steps.summary.outputs.result }}\n\n---\n*Powered by ${{ env.GITHUB_MODEL_DISPLAY }}*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  copilot-fix:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/copilot_fix')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.issue.number }} > diff.txt
          DIFF=$(cat diff.txt | head -c 25000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate fix with GitHub Models
        id: fix
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const diff = `${{ steps.diff.outputs.diff }}`;
            const prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’åˆ†æã—ã€å…·ä½“çš„ãªä¿®æ­£ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## å‡ºåŠ›å½¢å¼
å„å•é¡Œã«ã¤ã„ã¦ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›:

### å•é¡Œ 1: [å•é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«]
**ãƒ•ã‚¡ã‚¤ãƒ«**: \`path/to/file.ts\`
**å•é¡Œç‚¹**: å•é¡Œã®èª¬æ˜
**ä¿®æ­£å‰**:
\`\`\`typescript
// ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰
\`\`\`
**ä¿®æ­£å¾Œ**:
\`\`\`typescript
// ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰
\`\`\`

---

## ã‚³ãƒ¼ãƒ‰å·®åˆ†
\`\`\`diff
${diff}
\`\`\``;

            try {
              const response = await fetch('https://models.github.ai/inference/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: '${{ env.GITHUB_MODEL }}',
                  messages: [{ role: 'user', content: prompt }],
                  max_tokens: 4096
                })
              });

              if (!response.ok) {
                const error = await response.text();
                core.setOutput('result', `âš ï¸ API Error (HTTP ${response.status}): ${error}`);
                return;
              }

              const data = await response.json();
              core.setOutput('result', data.choices[0].message.content);
            } catch (error) {
              core.setOutput('result', `âš ï¸ Error: ${error.message}`);
            }

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ”§ Fix Suggestions\n\n${{ steps.fix.outputs.result }}\n\n---\n*Powered by ${{ env.GITHUB_MODEL_DISPLAY }}*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  # ============================================
  # Claude Commands: /claude_review, /claude_summary, /claude_fix
  # ============================================
  claude-review:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/claude_review')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ã“ã®PRã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            1. ãƒã‚°ã‚„æ½œåœ¨çš„ãªå•é¡Œ
            2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç‚¹
            4. ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§
            5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¸ã®æº–æ‹ 

            ## å‡ºåŠ›å½¢å¼
            - å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«åã¨è¡Œã‚’ç¤ºã—ã¦ãã ã•ã„
            - æ”¹å–„æ¡ˆãŒã‚ã‚Œã°å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚’æç¤ºã—ã¦ãã ã•ã„
            - å•é¡ŒãŒãªã‘ã‚Œã°ã€ŒLGTMã€ã¨å›ç­”ã—ã¦ãã ã•ã„
            - æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„
          model: ${{ env.CLAUDE_MODEL }}
          timeout_minutes: 10

  claude-summary:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/claude_summary')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude PR Summary
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ã“ã®PRã®å¤‰æ›´å†…å®¹ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚

            ## å‡ºåŠ›å½¢å¼
            ### æ¦‚è¦
            ï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰

            ### ä¸»ãªå¤‰æ›´ç‚¹
            - ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™

            ### å½±éŸ¿ç¯„å›²
            - å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½

            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹

            æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
          model: ${{ env.CLAUDE_MODEL }}
          timeout_minutes: 10

  claude-fix:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/claude_fix')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Fix Suggestions
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ã“ã®PRã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’åˆ†æã—ã€å…·ä½“çš„ãªä¿®æ­£ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

            ## å‡ºåŠ›å½¢å¼
            å„å•é¡Œã«ã¤ã„ã¦ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›:

            ### å•é¡Œ 1: [å•é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«]
            **ãƒ•ã‚¡ã‚¤ãƒ«**: `path/to/file.ts`
            **å•é¡Œç‚¹**: å•é¡Œã®èª¬æ˜
            **ä¿®æ­£å‰**:
            ```typescript
            // ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰
            ```
            **ä¿®æ­£å¾Œ**:
            ```typescript
            // ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰
            ```

            æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
          model: ${{ env.CLAUDE_MODEL }}
          timeout_minutes: 10

  # ============================================
  # PRä½œæˆæ™‚ã®è‡ªå‹•ã‚µãƒãƒªãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
  # Gemini â†’ GitHub Copilot â†’ Claude ã®é †ã§è©¦è¡Œ
  # ============================================
  auto-summary:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            return {
              title: context.payload.pull_request.title,
              body: context.payload.pull_request.body || '',
              commits: commits.data.map(c => c.commit.message).join('\n')
            };

      - name: Get changed files
        id: files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          FILES=$(git diff --name-status origin/${{ github.event.pull_request.base.ref }}..HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Step 1: Try Gemini
      - name: Try Gemini
        id: gemini
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://generativelanguage.googleapis.com/v1beta/models/${{ env.GEMINI_MODEL }}:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @- <<'PAYLOAD'
          {"contents":[{"parts":[{"text":"ä»¥ä¸‹ã®Pull Requestæƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚µãƒãƒªãƒ¼ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n## å‡ºåŠ›å½¢å¼\n### æ¦‚è¦\nï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰\n\n### ä¸»ãªå¤‰æ›´ç‚¹\n- ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™\n\n### å½±éŸ¿ç¯„å›²\n- å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½\n\n### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ\n- ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹\n\n---\n\n## PRæƒ…å ±\nã‚¿ã‚¤ãƒˆãƒ«: ${{ fromJson(steps.pr.outputs.result).title }}\n\nèª¬æ˜:\n${{ fromJson(steps.pr.outputs.result).body }}\n\nã‚³ãƒŸãƒƒãƒˆ:\n${{ fromJson(steps.pr.outputs.result).commits }}\n\nå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:\n${{ steps.files.outputs.files }}"}]}],"generationConfig":{"temperature":0.3,"maxOutputTokens":2048}}
          PAYLOAD
          )
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          if [ "$HTTP_CODE" = "200" ]; then
            RESULT=$(echo "$BODY" | jq -r '.candidates[0].content.parts[0].text // ""')
            if [ -n "$RESULT" ] && [ "$RESULT" != "null" ]; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "result<<EOF" >> $GITHUB_OUTPUT
              echo "$RESULT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "provider=${{ env.GEMINI_MODEL_DISPLAY }}" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "success=false" >> $GITHUB_OUTPUT

      # Step 2: Try GitHub Models (if Gemini failed)
      - name: Try GitHub Models
        id: github_models
        if: steps.gemini.outputs.success != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const prInfo = ${{ steps.pr.outputs.result }};
            const files = `${{ steps.files.outputs.files }}`;
            const prompt = `ä»¥ä¸‹ã®Pull Requestæƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚µãƒãƒªãƒ¼ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å‡ºåŠ›å½¢å¼
### æ¦‚è¦
ï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰

### ä¸»ãªå¤‰æ›´ç‚¹
- ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™

### å½±éŸ¿ç¯„å›²
- å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹

---

## PRæƒ…å ±
ã‚¿ã‚¤ãƒˆãƒ«: ${prInfo.title}

èª¬æ˜:
${prInfo.body}

ã‚³ãƒŸãƒƒãƒˆ:
${prInfo.commits}

å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:
${files}`;

            try {
              const response = await fetch('https://models.github.ai/inference/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: '${{ env.GITHUB_MODEL }}',
                  messages: [{ role: 'user', content: prompt }],
                  max_tokens: 2048
                })
              });

              if (response.ok) {
                const data = await response.json();
                core.setOutput('success', 'true');
                core.setOutput('result', data.choices[0].message.content);
                core.setOutput('provider', '${{ env.GITHUB_MODEL_DISPLAY }}');
                return;
              }
            } catch (error) {
              console.log('GitHub Models failed:', error.message);
            }
            core.setOutput('success', 'false');

      # Step 3: Try Claude (if both failed)
      - name: Try Claude
        id: claude
        if: steps.gemini.outputs.success != 'true' && steps.github_models.outputs.success != 'true' && secrets.ANTHROPIC_API_KEY != ''
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @- <<'PAYLOAD'
          {"model":"${{ env.CLAUDE_MODEL }}","max_tokens":2048,"messages":[{"role":"user","content":"ä»¥ä¸‹ã®Pull Requestæƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚µãƒãƒªãƒ¼ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n## å‡ºåŠ›å½¢å¼\n### æ¦‚è¦\nï¼ˆ1-2æ–‡ã§å¤‰æ›´ã®ç›®çš„ã‚’èª¬æ˜ï¼‰\n\n### ä¸»ãªå¤‰æ›´ç‚¹\n- ç®‡æ¡æ›¸ãã§ä¸»è¦ãªå¤‰æ›´ã‚’åˆ—æŒ™\n\n### å½±éŸ¿ç¯„å›²\n- å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„æ©Ÿèƒ½\n\n### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ\n- ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç‰¹ã«ç¢ºèªã™ã¹ãç‚¹\n\n---\n\n## PRæƒ…å ±\nã‚¿ã‚¤ãƒˆãƒ«: ${{ fromJson(steps.pr.outputs.result).title }}\n\nèª¬æ˜:\n${{ fromJson(steps.pr.outputs.result).body }}\n\nã‚³ãƒŸãƒƒãƒˆ:\n${{ fromJson(steps.pr.outputs.result).commits }}\n\nå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:\n${{ steps.files.outputs.files }}"}]}
          PAYLOAD
          )
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          if [ "$HTTP_CODE" = "200" ]; then
            RESULT=$(echo "$BODY" | jq -r '.content[0].text // ""')
            if [ -n "$RESULT" ] && [ "$RESULT" != "null" ]; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "result<<EOF" >> $GITHUB_OUTPUT
              echo "$RESULT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "provider=${{ env.CLAUDE_MODEL_DISPLAY }}" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "success=false" >> $GITHUB_OUTPUT

      # Post the result
      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            let result = '';
            let provider = '';

            if ('${{ steps.gemini.outputs.success }}' === 'true') {
              result = `${{ steps.gemini.outputs.result }}`;
              provider = '${{ steps.gemini.outputs.provider }}';
            } else if ('${{ steps.github_models.outputs.success }}' === 'true') {
              result = `${{ steps.github_models.outputs.result }}`;
              provider = '${{ steps.github_models.outputs.provider }}';
            } else if ('${{ steps.claude.outputs.success }}' === 'true') {
              result = `${{ steps.claude.outputs.result }}`;
              provider = '${{ steps.claude.outputs.provider }}';
            } else {
              result = 'âš ï¸ ã™ã¹ã¦ã®AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ã‚µãƒãƒªãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„:\n- `GEMINI_API_KEY`\n- `ANTHROPIC_API_KEY`\n\nGitHub Modelsã¯ `GITHUB_TOKEN` ã§è‡ªå‹•çš„ã«åˆ©ç”¨å¯èƒ½ã§ã™ã€‚';
              provider = 'N/A';
            }

            const body = `## ğŸ“‹ PR Summary\n\n${result}\n\n---\n*Powered by ${provider}*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
