# データベース連携機能ガイド

## 概要

Comm Timeは、TODOリストとメモをクラウドに保存し、複数デバイス間で同期できるデータベース連携機能を提供しています。

## 新機能 (2025-01-18)

### 1. データベース連携の自動有効化

- **ログイン後、データベース連携が自動的にONになります**
- リロードしても設定が保持されます
- ログアウトしない限り、常にクラウド同期が有効です

### 2. 共通メモ/TODO

- **ミーティングタイマーとポモドーロタイマーで、メモ/TODOが共有されるようになりました**
- どちらのタイマーでも同じメモとTODOが表示されます
- タイマーを切り替えても、データは保持されます

### 3. アクティブタブの記憶

- **最後に使用していたタイマー（ミーティング/ポモドーロ）がリロード後も復元されます**
- 作業を中断しても、次回起動時に同じタイマーが表示されます

### 4. 一括削除機能

TODOリストとメモに、一括削除機能が追加されました：

#### TODOリスト
- **完了削除**: 完了済みのTODOのみを削除
- **全削除**: すべてのTODOを削除

#### メモ
- **クリア**: メモの内容をすべて削除

## 使い方

### 1. ログインとデータベース連携

#### 初回ログイン

1. 右上のログインアイコンをクリック
2. メールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック

ログイン成功後、**データベース連携が自動的にONになります**。

#### データベース連携アイコン

ヘッダー右側に表示される緑色のデータベースアイコン（🗄️）：
- **緑色**: データベース連携がON（クラウドに保存中）
- **グレー**: データベース連携がOFF（ローカルのみ）

通常は、ログイン後は常に緑色になります。

### 2. メモ/TODOの共有

#### どちらのタイマーでも同じデータ

- ミーティングタイマーで追加したTODOは、ポモドーロタイマーでも表示されます
- ポモドーロタイマーで書いたメモは、ミーティングタイマーでも表示されます

#### 利用例

1. **ミーティングタイマー**でミーティング中にTODOを追加
2. ミーティング終了後、**ポモドーロタイマー**に切り替え
3. 同じTODOリストを見ながら、ポモドーロで作業

### 3. 一括削除機能

#### 完了したTODOを削除

1. TODOリストの右上にある「完了削除」ボタンをクリック
2. 確認ダイアログが表示されます
3. 「OK」をクリックすると、完了済みのTODOが削除されます

**使い方の例:**
- 完了したタスクが溜まってきたら、定期的に「完了削除」でクリーンアップ

#### すべてのTODOを削除

1. TODOリストの右上にある「全削除」ボタンをクリック
2. 確認ダイアログが表示されます
3. 「OK」をクリックすると、すべてのTODOが削除されます

**注意:** この操作は取り消せません！

**使い方の例:**
- プロジェクトが終了したら、「全削除」で一括クリア
- 新しいタスクセットを始める前にリセット

#### メモをクリア

1. メモセクションの右上にある「クリア」ボタンをクリック
2. 確認ダイアログが表示されます
3. 「OK」をクリックすると、メモが空になります

**使い方の例:**
- ミーティングが終わったら、メモをクリアして次のミーティングに備える

### 4. データの同期

#### 自動同期

- データベース連携がONの場合、以下の操作が自動的にクラウドに保存されます：
  - TODO の追加・編集・削除・完了
  - メモの編集
  - 一括削除操作

#### マルチデバイス同期

1. デバイスAでログインしてTODOを追加
2. デバイスBで同じアカウントにログイン
3. デバイスBにもTODOが自動的に表示されます

リアルタイムで同期されるため、他のデバイスでの変更もすぐに反映されます。

### 5. ローカルモード（オフライン）

データベース連携をOFFにすると、ローカルモードになります：

#### ローカルモードの動作

- データはブラウザのローカルストレージに保存されます
- 他のデバイスとは同期されません
- ブラウザを閉じてもデータは保持されます
- ブラウザのキャッシュをクリアするとデータが消えます

#### ローカルモードへの切り替え

1. ヘッダー右側のデータベースアイコンをクリック
2. アイコンがグレーになり、ローカルモードに切り替わります

**注意:** ローカルモードに切り替えると、クラウドのデータは表示されなくなります。

## よくある質問（FAQ）

### Q1: ログイン後、データベース連携が自動的にONにならない

**A:** 以下を確認してください：

1. Supabaseが正しく設定されているか
   - ブラウザの開発者ツールを開く（F12キー）
   - コンソールに「⚠️ Supabase is not configured」と表示されていないか確認

2. 環境変数が設定されているか（開発者向け）
   - `.env.local` ファイルに `NEXT_PUBLIC_SUPABASE_URL` と `NEXT_PUBLIC_SUPABASE_ANON_KEY` が設定されているか

3. Vercelの環境変数が設定されているか（本番環境）
   - [VERCEL_SETUP.md](../VERCEL_SETUP.md) を参照

### Q2: リロードするとデータベース連携がOFFになる

**A:** 通常、ログイン状態が保持されていれば、データベース連携もONのままです。

**対処法:**
1. もう一度ログインしてください
2. ブラウザのCookieが有効になっているか確認
3. シークレットモード/プライベートブラウズモードを使用していないか確認

### Q3: ミーティングとポモドーロのメモを別々に管理したい

**A:** 現在のバージョンでは、メモとTODOは共通です。

別々に管理したい場合は、以下の方法があります：
- メモの中で見出しを使って区別する（例: `## ミーティング`, `## ポモドーロ`）
- 外部のメモアプリを併用する

### Q4: 削除したTODOを復元できますか？

**A:** 残念ながら、削除したTODOは復元できません。

**対策:**
- 削除する前に、確認ダイアログをよく読む
- 重要なTODOは、削除の前にメモにコピーしておく

### Q5: データベースとローカルストレージの違いは？

| 項目 | データベース連携ON | ローカルストレージ |
|------|-------------------|-------------------|
| 保存場所 | クラウド（Supabase） | ブラウザ内 |
| 他デバイスとの同期 | ⭕ 可能 | ❌ 不可 |
| オフラインでの使用 | ⚠️ 制限あり | ⭕ 可能 |
| データの永続性 | ⭕ 永続的 | ⚠️ ブラウザ依存 |
| ログイン | ⭕ 必要 | ❌ 不要 |

## トラブルシューティング

### データが同期されない

1. **ネットワーク接続を確認**
   - インターネットに接続されているか確認

2. **ログイン状態を確認**
   - 右上のユーザーアイコンが表示されているか
   - 表示されていない場合は、再ログイン

3. **データベース連携を確認**
   - データベースアイコンが緑色になっているか
   - グレーの場合は、アイコンをクリックしてONにする

4. **ブラウザをリロード**
   - F5キーを押してページをリロード

### エラーメッセージが表示される

#### "Supabaseが設定されていません"

- 環境変数が設定されていません
- [VERCEL_SETUP.md](../VERCEL_SETUP.md) を参照して設定してください

#### "Failed to fetch"

- ネットワーク接続の問題
- インターネット接続を確認してください

#### "このメールアドレスでのログインは許可されていません"

- 環境変数 `NEXT_PUBLIC_ALLOWED_EMAILS` で許可されたメールアドレスのみログインできます
- 管理者に連絡してください

## 参考リンク

- [Supabase Setup Guide](../SUPABASE_SETUP.md) - Supabaseの設定方法
- [Vercel Setup Guide](../VERCEL_SETUP.md) - Vercelの環境変数設定
- [Developer Guide](./DEVELOPER_GUIDE.md) - 開発者向けガイド
- [User Guide](./USER_GUIDE.md) - 基本的な使い方

## まとめ

データベース連携機能により、以下が可能になりました：

- ✅ ログイン後、自動的にクラウド同期
- ✅ ミーティング/ポモドーロで共通のメモ/TODO
- ✅ リロードしても設定とデータが保持
- ✅ 一括削除機能でデータ管理が簡単
- ✅ マルチデバイス対応

快適なタイムマネジメントをお楽しみください！
